<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR1 ‚Äì U-Label Multilenguaje</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 2rem; background: #fff; color: #000; max-width: 520px; margin: auto; }
    h1 { font-size: 1.4rem; margin-top: 1rem; text-align: center; }
    .subtitle { text-align: center; font-size: 0.9rem; color: #555; margin-bottom: 2rem; }
    .section { margin-top: 1.5rem; border-top: 1px solid #ddd; padding-top: 1rem; }
    .section h2 { font-size: 0.95rem; margin-bottom: 0.5rem; }
    .footer { margin-top: 2rem; font-size: 0.9rem; text-align: center; }
    .language-selector { position: absolute; top: 1rem; right: 1rem; }
    select { padding: 0.3rem; font-size: 0.9rem; }
    a { color: #007bff; text-decoration: none; }
    #debug { font-size:.8rem; color:#444; margin:.75rem 0 0; white-space:pre-wrap; word-break:break-all; border-top:1px dashed #ccc; padding-top:.5rem }
  </style>
</head>
<body>
  <div class="language-selector">
    <label for="lang">üåê</label>
    <select id="lang" aria-label="Seleccionar idioma"></select>
  </div>

  <h1 id="title">DIGITAL PRODUCT LABEL</h1>
  <div class="subtitle" id="subtitle">Information provided via a QR code on the beverage packaging</div>

  <div class="section">
    <h2 id="ingredientsTitle">INGREDIENTS</h2>
    <p id="ingredientes"></p>
  </div>

  <div class="section">
    <h2 id="nutritionTitle">NUTRITION INFORMATION</h2>
    <p id="nutricion"></p>
  </div>

  <div class="section">
    <h2 id="allergensTitle">ALLERGENS</h2>
    <p id="alergenos"></p>
  </div>

  <div class="section">
    <h2 id="alcoholTitle">ALCOHOL CONTENT & VOLUME</h2>
    <p id="alcoholData"></p>
  </div>

  <div class="footer">
    <p id="footerMore">Want to learn more about this wine?</p>
    <a id="qr2link" href="https://sommelierlab.com/">View profile ‚Üí</a>
    <div id="debug"></div>
  </div>

  <script>
    /** ====== CONFIG (con overrides por query) ====== **/
    const qs = new URLSearchParams(location.search);

    // Forzar CDN por query: &cdn=https://f005.backblazeb2.com/file/TU_BUCKET
    const OVERRIDE_CDN = qs.get('cdn');
    const CDN_BASE   = OVERRIDE_CDN || "https://f005.backblazeb2.com/file/TU_BUCKET"; // ‚Üê PON aqu√≠ tu Friendly URL o S3
    const PREFIX_QR1 = "qr1";
    const VERSION    = "";              // ej: "?v={{source_hash}}"
    const LABELS_URL = "./qr1.labels.ue.json";

    // Forzar archivo directo (bypassa ruta): &file=https://.../qr1/V001/es.json
    const FILE_URL   = qs.get('file');

    // 27 idiomas
    const LANGS = ["es","ca","eu","gl","bg","cs","da","de","el","en","et","fi","fr","ga","hr","it","lv","lt","hu","mt","nl","pl","pt","ro","sk","sl","sv"];
    const FALLBACKS = ["en","es"];
    const NATIVE = {bg:'–ë—ä–ª–≥–∞—Ä—Å–∫–∏', cs:'ƒåe≈°tina', da:'Dansk', de:'Deutsch', et:'Eesti', el:'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
      en:'English', es:'Espa√±ol', fr:'Fran√ßais', ga:'Gaeilge', hr:'Hrvatski', it:'Italiano',
      lv:'Latvie≈°u', lt:'Lietuvi≈≥', hu:'Magyar', mt:'Malti', nl:'Nederlands', pl:'Polski',
      pt:'Portugu√™s', ro:'Rom√¢nƒÉ', sk:'Slovenƒçina', sl:'Sloven≈°ƒçina', fi:'Suomi', sv:'Svenska',
      ca:'Catal√†', eu:'Euskara', gl:'Galego' };

    /** ====== HELPERS ====== **/
    let LABELS = null;

    // Acepta id/vino_id/vino
    const vinoId = qs.get('id') || qs.get('vino_id') || qs.get('vino') || qs.get('VINO_ID') || "";

    const norm = s => String(s||"").trim().toLowerCase().slice(0,5);
    const inLangs = l => LANGS.includes(l);
    const jsonUrl = (vino, lang, prefix=PREFIX_QR1) =>
      `${CDN_BASE}/${prefix}/${encodeURIComponent(vino)}/${lang}.json${VERSION ? ("?" + VERSION.replace(/^\?/, "")) : ""}`;

    const memo = new Map();
    const $debug = document.getElementById('debug');
    function dbg(line){
      const ts = new Date().toISOString().slice(11,19);
      $debug.textContent += `[${ts}] ${line}\n`;
      console.log(line);
    }
    function link(url){ return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`; }

    /** ====== LABELS UI ====== **/
    async function loadLabels() {
      try {
        const res = await fetch(LABELS_URL, { cache: 'no-store' });
        LABELS = await res.json();
      } catch {
        LABELS = { en: { title: 'DIGITAL PRODUCT LABEL', subtitle: '', ingredients: 'INGREDIENTS', nutrition: 'NUTRITION INFORMATION', allergens: 'ALLERGENS', alcohol: 'ALCOHOL CONTENT & VOLUME', more: 'Learn more about this wine?', view: 'View profile ‚Üí' } };
        dbg('No se pudo cargar qr1.labels.ue.json; usando fallback EN.');
      }
    }

    function getInitialLang() {
      const fromUrl = (qs.get('idioma') || qs.get('lang') || '').slice(0,2).toLowerCase();
      const fromLS  = (localStorage.getItem('qr1.lang') || '').slice(0,2).toLowerCase();
      const fromNav = (navigator.language || 'en').slice(0,2).toLowerCase();
      const preferred = [fromUrl, fromLS, fromNav, 'en'].find(l => l && inLangs(l));
      return preferred || 'en';
    }

    function applyLang(lang) {
      const t = (LABELS && LABELS[lang]) || (LABELS && LABELS.en) || {};
      document.getElementById('title').textContent            = t.title || 'DIGITAL PRODUCT LABEL';
      document.getElementById('subtitle').textContent         = t.subtitle || '';
      document.getElementById('ingredientsTitle').textContent = t.ingredients || 'INGREDIENTS';
      document.getElementById('nutritionTitle').textContent   = t.nutrition || 'NUTRITION INFORMATION';
      document.getElementById('allergensTitle').textContent   = t.allergens || 'ALLERGENS';
      document.getElementById('alcoholTitle').textContent     = t.alcohol || 'ALCOHOL CONTENT & VOLUME';
      document.getElementById('footerMore').textContent       = t.more || 'Want to learn more about this wine?';
      document.getElementById('qr2link').textContent          = t.view || 'View profile ‚Üí';

      localStorage.setItem('qr1.lang', lang);
      const url = new URL(location.href);
      url.searchParams.set('idioma', lang);
      url.searchParams.set('lang', lang);
      history.replaceState({}, '', url.toString());

      const a = document.getElementById('qr2link');
      if (a) {
        const u = new URL(a.href);
        if (vinoId) u.searchParams.set('vino_id', vinoId);
        u.searchParams.set('idioma', lang);
        u.searchParams.set('lang', lang);
        u.searchParams.set('qr','1');
        a.href = u.toString();
      }

      loadWine(lang);
    }

    /** ====== FETCH con logging acumulado ====== **/
    async function fetchQrPayload(vino, requestedLang, prefix=PREFIX_QR1) {
      if (!vino) throw new Error("vino_id vac√≠o");
      const chain = [requestedLang, ...FALLBACKS.filter(l => l !== requestedLang)];
      dbg(`Resolviendo JSON ‚Üí vino_id=${vino} ¬∑ pedido=${requestedLang} ¬∑ cadena=${chain.join(' ‚Üí ')}`);

      for (const lang of chain) {
        const key = `${prefix}:${vino}:${lang}`;
        const url = jsonUrl(vino, lang, prefix);

        if (memo.has(key)) {
          dbg(`CACHE ‚úÖ ${url}`);
          return { lang, data: memo.get(key) };
        }

        try {
          dbg(`FETCH  ‚Üí ${url}`);
          const res = await fetch(url, { cache: "no-store" });
          dbg(`STATUS ‚Üê ${res.status} | ${url}`);
          if (res.ok) {
            const data = await res.json();
            memo.set(key, data);
            dbg(`OK JSON ‚úÖ ${url}`);
            return { lang, data };
          }
        } catch (e) {
          dbg(`ERROR  ‚õî (red/CORS) ${url}`);
        }
      }
      throw new Error("No disponible en los idiomas probados");
    }

    /** ====== Render contenido QR1 ====== **/
    function renderWine(payload) {
      const get = (...keys) => {
        for (const k of keys) {
          const v = payload?.[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") return String(v);
        }
        return "";
      };

      document.getElementById('ingredientes').textContent = get('ingredientes_texto','Ingredientes','ingredientes') || '‚Äî';
      document.getElementById('nutricion').textContent    = get('nutricion_texto','Informaci√≥n nutricional','Informacion nutricional','nutrition_text','Nutrition') || '';
      document.getElementById('alergenos').textContent    = get('alergenos_texto','Al√©rgenos','Alergenos','al√©rgenos') || '';
      const grad  = get('graduacion_texto','Graduaci√≥n','Graduacion','ABV','Alcohol');
      const vol   = get('volumen_texto','Volumen','Contenido','Tama√±o');
      document.getElementById('alcoholData').textContent  = [grad, vol].filter(Boolean).join(' ‚Ä¢ ') || grad || vol || '';
    }

    async function loadWine(requestedLang) {
      // Modo test: FILE_URL bypass (para aislar problema de ruta/CDN)
      if (FILE_URL) {
        dbg(`OVERRIDE file= activo ‚Üí ${FILE_URL}`);
        try {
          const r = await fetch(FILE_URL, { cache: 'no-store' });
          dbg(`STATUS ‚Üê ${r.status} | ${FILE_URL}`);
          if (!r.ok) throw new Error('status ' + r.status);
          const data = await r.json();
          renderWine(data);
          return;
        } catch (e) {
          dbg('Fallo cargando FILE_URL (revisa la URL exacta, permisos o CORS)');
          return;
        }
      }

      if (!vinoId) {
        dbg('FALTA par√°metro ?id=VXXX (o ?vino_id=VXXX) en la URL del QR');
        ['ingredientes','nutricion','alergenos','alcoholData'].forEach(id => document.getElementById(id).textContent = '');
        return;
      }

      if (CDN_BASE.includes('TU_BUCKET')) {
        dbg('Recuerda: configura CDN_BASE o usa &cdn=https://... para probar con tu bucket real.');
      }
      dbg(`Contexto ‚Üí CDN_BASE=${CDN_BASE} ¬∑ PREFIX=${PREFIX_QR1} ¬∑ vino_id=${vinoId}`);

      const langReq = inLangs(norm(requestedLang)) ? norm(requestedLang) : 'en';
      try {
        const { lang, data } = await fetchQrPayload(vinoId, langReq, PREFIX_QR1);
        renderWine(Object.assign({ vino_id: vinoId, lang }, data));
      } catch {
        dbg('No se pudo cargar el JSON del vino (revisa CDN_BASE, ruta y permisos).');
        ['ingredientes','nutricion','alergenos','alcoholData'].forEach(id => document.getElementById(id).textContent = '');
      }
    }

    /** ====== INIT ====== **/
    async function init() {
      await loadLabels();

      // Selector con 27 idiomas
      const sel = document.getElementById('lang');
      sel.innerHTML = LANGS.map(c => `<option value="${c}">${NATIVE[c]||c.toUpperCase()}</option>`).join('');

      const initial = (() => {
        const fromUrl = (qs.get('idioma') || qs.get('lang') || '').slice(0,2).toLowerCase();
        const fromLS  = (localStorage.getItem('qr1.lang') || '').slice(0,2).toLowerCase();
        const fromNav = (navigator.language || 'en').slice(0,2).toLowerCase();
        const preferred = [fromUrl, fromLS, fromNav, 'en'].find(l => l && inLangs(l));
        return preferred || 'en';
      })();

      sel.value = initial;
      sel.addEventListener('change', () => applyLang(sel.value));
      applyLang(initial);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script id="qr1-loader">
(function(){
  const CDN_BASE = window.CDN_BASE || "https://f005.backblazeb2.com/file/SommelierLab-media";
  const PREFIX   = window.PREFIX   || "qr1";
  const vino_id  = window.vino_id  || "V001";

  // 1) Idioma pedido: ?lang=xx ‚Üí window.pedido ‚Üí navigator.language ‚Üí 'es'
  const urlLang  = new URLSearchParams(location.search).get("lang");
  const navLang  = (navigator.language || "es").toLowerCase();
  const pedido   = (window.pedido || urlLang || navLang).toLowerCase();

  // 2) Conjunto de idiomas soportados (UE + cooficiales que usas)
  const SUP = new Set([
    "bg","cs","da","de","el","en","es","et","fi","fr","ga","hr","hu","it",
    "lt","lv","mt","nl","pl","pt","ro","sk","sl","sv","eu","ca","gl"
  ]);

  // 3) Cadena de fallback (p.ej. "pt-BR"‚Üí["pt-br","pt","en","es"])
  const base = pedido.split("-")[0];
  const chain = [];
  if (pedido && SUP.has(pedido)) chain.push(pedido);
  if (base && base !== pedido && SUP.has(base)) chain.push(base);
  chain.push("en","es");
  const langs = [...new Set(chain)]; // sin duplicados

  const v = window.source_hash ? `?v=${window.source_hash}` : "";

  const tryFetch = async (lang) => {
    const url = `${CDN_BASE}/${PREFIX}/${encodeURIComponent(vino_id)}/${lang}.json${v}`;
    console.log(`[QR1] FETCH  ‚Üí ${url}`);
    const res = await fetch(url, { method: "GET", mode: "cors", cache: "no-cache" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  };

  (async () => {
    console.log(`[QR1] Contexto ‚Üí CDN_BASE=${CDN_BASE} ¬∑ PREFIX=${PREFIX} ¬∑ vino_id=${vino_id}`);
    console.log(`[QR1] Resolviendo JSON ‚Üí vino_id=${vino_id} ¬∑ pedido=${pedido} ¬∑ cadena=${langs.join(" ‚Üí ")}`);

    let data=null, used=null, lastErr=null;
    for (const lang of langs) {
      try { data = await tryFetch(lang); used = lang; break; }
      catch (e) { console.warn(`[QR1] ${lang}.json fall√≥ ‚Üí`, e?.message || e); lastErr = e; }
    }

    if (!data) { console.error("[QR1] No se pudo cargar ning√∫n JSON.", lastErr); return; }

    console.log(`[QR1] OK JSON ‚úÖ (${used})`);
    window.__QR1_DATA__ = data;
    window.__QR1_LANG__ = used;
    document.dispatchEvent(new CustomEvent("qr1:loaded", { detail: { lang: used, data } }));
    // aqu√≠ puedes llamar a tu renderizador, ej.: renderQR1(data);
  })();
})();
</script>
  
</body>
</html>
