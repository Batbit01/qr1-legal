<script>
  const translations = {
    es: {
      title: "ETIQUETA DIGITAL DEL PRODUCTO",
      subtitle: "Información proporcionada mediante código QR en el envase de la bebida",
      ingredients: "INGREDIENTES",
      nutrition: "DECLARACIÓN NUTRICIONAL",
      allergens: "ALÉRGENOS",
      more: "¿Quieres saber más sobre este vino?",
      view: "Ver perfil sensorial →"
    },
    en: {
      title: "DIGITAL PRODUCT LABEL",
      subtitle: "Information provided via a QR code on the beverage packaging",
      ingredients: "INGREDIENTS",
      nutrition: "NUTRITION DECLARATION",
      allergens: "ALLERGENS",
      more: "Want to learn more about this wine?",
      view: "View sensory profile →"
    },
    fr: {
      title: "ÉTIQUETTE NUMÉRIQUE DU PRODUIT",
      subtitle: "Informations fournies via un code QR sur l'emballage de la boisson",
      ingredients: "INGRÉDIENTS",
      nutrition: "DÉCLARATION NUTRITIONNELLE",
      allergens: "ALLERGÈNES",
      more: "Vous souhaitez en savoir plus sur ce vin ?",
      view: "Voir le profil sensoriel →"
    },
    de: {
      title: "DIGITALES PRODUKTETIKETT",
      subtitle: "Informationen über einen QR-Code auf der Verpackung des Getränks bereitgestellt",
      ingredients: "ZUTATEN",
      nutrition: "NÄHRWERTDEKLARATION",
      allergens: "ALLERGENE",
      more: "Möchten Sie mehr über diesen Wein erfahren?",
      view: "Sensorisches Profil ansehen →"
    }
  };

  async function loadVinoData() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const vinoId = urlParams.get('vino_id');
      const langParam = urlParams.get('lang') || 'en';

      console.log("vino_id:", vinoId);
      console.log("lang:", langParam);

      const langSelect = document.getElementById("lang");
      langSelect.value = langParam;
      langSelect.addEventListener("change", () => {
        window.location.href = `${window.location.pathname}?vino_id=${vinoId}&lang=${langSelect.value}`;
      });

      if (!vinoId) {
        console.error("No vino_id provided in URL.");
        return;
      }

      const response = await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino-legal/${vinoId}`);
      if (!response.ok) throw new Error("Error al consultar la API: " + response.status);
      
      const data = await response.json();
      console.log("Datos recibidos:", data);

      // Imagen
      if (data.imagen && data.imagen[0] && data.imagen[0].url) {
        document.getElementById("vinoImagen").src = data.imagen[0].url;
      }

      document.getElementById("vinoNombre").textContent = data.nombre || "Nombre no disponible";
      document.getElementById("ingredientes").textContent = data.ingredientes || "-";
      document.getElementById("nutricion").textContent = `Energy ${data.valor_energetico_kcal || 0} kcal (${data.valor_energetico_kj || 0} kJ) per 100 ml`;
      document.getElementById("nutricion_ext").textContent = `Fat ${data.grasas || 0}g (saturated ${data.grasas_saturadas || 0}g), Carbs ${data.hidratos || 0}g (sugars ${data.azucares || 0}g), Protein ${data.proteinas || 0}g, Salt ${data.sal || 0}g`;
      document.getElementById("alergenos").textContent = `Contains: ${data.alergenos || "-"}`;

      // Iconos y enlaces
      document.getElementById("icono_embarazo").src = data.icono_embarazo || "";
      document.getElementById("icono_menores").src = data.icono_menores || "";
      document.getElementById("logo_moderation").src = data.logo_moderation || "";
      document.getElementById("texto_moderation").textContent = data.texto_moderation || "";
      document.getElementById("link_moderation").href = data.enlace_moderation || "#";
      document.getElementById("icono_reciclaje").src = data.icono_reciclaje || "";
      document.getElementById("texto_reciclaje").textContent = data.texto_reciclaje || "";

      // Enlace al perfil QR2
      document.getElementById("qr2link").href = `${data.url_qr2}?vino_id=${vinoId}&lang=${langParam}`;

      // Traducciones
      const t = translations[langParam] || translations.en;
      document.getElementById("title").textContent = t.title;
      document.getElementById("subtitle").textContent = t.subtitle;
      document.getElementById("ingredientsTitle").textContent = t.ingredients;
      document.getElementById("nutritionTitle").textContent = t.nutrition;
      document.getElementById("allergensTitle").textContent = t.allergens;
      document.getElementById("footerMore").textContent = t.more;
      document.getElementById("qr2link").textContent = t.view;

    } catch (error) {
      console.error("❌ Error en loadVinoData:", error);
    }
  }

  loadVinoData();
</script>
